name: CI

on:
    push:
        branches: [ main, master ]
        tags:
            - 'v*'
    pull_request:
        branches: [ main, master ]
    release:
        types: [ published ]

jobs:
    lint-and-test:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [ 18.x, 20.x, 22.x ]

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Use Node.js ${{ matrix.node-version }}
                uses: actions/setup-node@v4
                with:
                    node-version: ${{ matrix.node-version }}
                    cache: 'npm'

            -   name: Install dependencies
                run: npm ci

            -   name: Run ESLint
                run: npm run lint

            -   name: Run tests
                run: npm run test

            -   name: Run build
                run: npm run build

    publish:
        needs: lint-and-test
        runs-on: ubuntu-latest
        if: github.event_name == 'release' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))

        permissions:
            id-token: write
            contents: read

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Use Node.js 20.x
                uses: actions/setup-node@v4
                with:
                    node-version: '20.x'
                    cache: 'npm'
                    registry-url: 'https://registry.npmjs.org'

            -   name: Install dependencies
                run: npm ci

            -   name: Run build
                run: npm run build

            -   name: Publish to NPM with provenance
                run: npm publish --provenance --access public